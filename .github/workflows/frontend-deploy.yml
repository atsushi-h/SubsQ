name: Frontend Deploy
run-name: Deploy to ${{ inputs.environment }}

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        default: dev
        options:
          - dev
          - prd

permissions:
  contents: read
  id-token: write

env:
  REGION: asia-northeast1
  SERVICE_NAME: subsq-frontend-${{ inputs.environment }}
  REPOSITORY: subsq-frontend-${{ inputs.environment }}
  IMAGE_NAME: app

jobs:
  build-and-deploy:
    name: Build and Deploy (${{ inputs.environment }})
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.1

      - name: Set image tag
        id: image_tag
        working-directory: frontend
        run: |
          # イメージタグの生成
          # 形式: v{package.jsonのバージョン}-{コミットハッシュの最初の7文字}
          # 例: v1.2.3-abc1234
          #   - v1.2.3: package.jsonのversionフィールドから取得
          #   - abc1234: 現在のコミットハッシュ（一意性を保証）
          VERSION=$(jq -r '.version' package.json)
          SHORT_SHA=${GITHUB_SHA:0:7}
          TAG="v${VERSION}-${SHORT_SHA}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "::notice::Image tag: $TAG"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.TERRAFORM_SERVICE_ACCOUNT_EMAIL }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3.0.1

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build Docker image
        working-directory: frontend
        run: |
          # NEXT_PUBLIC_APP_URL は公開情報なのでビルド時に渡してOK
          # DATABASE_URL はダミー値で検証をパス（実際の値はランタイムで渡す）
          # その他の機密情報（GOOGLE_CLIENT_SECRET等）はビルド時に含めない（セキュリティベストプラクティス）
          docker build \
            --build-arg NEXT_PUBLIC_APP_URL=${{ secrets.NEXT_PUBLIC_APP_URL }} \
            --build-arg DATABASE_URL="postgresql://build-dummy:dummy@localhost:5432/dummy" \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ steps.image_tag.outputs.tag }} \
            .

      - name: Push Docker image to Artifact Registry
        run: |
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ steps.image_tag.outputs.tag }}

      - name: Check if Cloud Run service exists
        run: |
          if ! gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(metadata.name)' 2>/dev/null; then
            echo "::error::Cloud Run service '${{ env.SERVICE_NAME }}' does not exist."
            echo "::error::Please create the service first by running 'terraform apply' with the terraform.yml workflow."
            exit 1
          fi
          echo "::notice::Cloud Run service exists. Proceeding with deployment."

      - name: Deploy to Cloud Run
        id: deploy
        run: |
          # 環境変数をランタイムで設定
          # すべての変数がサーバーサイドのみで使用されるため、
          # ビルド時ではなくランタイムで渡すことでセキュリティを確保
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image=${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ steps.image_tag.outputs.tag }} \
            --region=${{ env.REGION }} \
            --set-env-vars="DATABASE_URL=${{ secrets.DATABASE_URL }},GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }},GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }},BETTER_AUTH_SECRET=${{ secrets.BETTER_AUTH_SECRET }},BETTER_AUTH_URL=${{ secrets.BETTER_AUTH_URL }},NEXT_PUBLIC_APP_URL=${{ secrets.NEXT_PUBLIC_APP_URL }},NODE_ENV=production,NEXT_TELEMETRY_DISABLED=1"

          # Get service URL
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_ENV
          echo "service_url=$SERVICE_URL" >> $GITHUB_OUTPUT

      - name: Update Cloudflare DNS
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          # Cloud Run URLからホスト名を抽出（https://を除去）
          CLOUD_RUN_HOST=$(echo "${{ env.SERVICE_URL }}" | sed 's|https://||')
          echo "Cloud Run Host: $CLOUD_RUN_HOST"

          # 環境に応じたサブドメインを設定
          if [ "${{ inputs.environment }}" == "dev" ]; then
            SUBDOMAIN="dev"
            FULL_DOMAIN="dev.subsq-app.com"
          else
            SUBDOMAIN=""
            FULL_DOMAIN="subsq-app.com"
          fi

          echo "::group::Update DNS Record"
          # DNSレコードIDを取得
          DNS_RECORD_ID=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/${CLOUDFLARE_ZONE_ID}/dns_records?type=CNAME&name=${FULL_DOMAIN}" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json" | jq -r '.result[0].id')

          if [ -z "$DNS_RECORD_ID" ] || [ "$DNS_RECORD_ID" == "null" ]; then
            echo "::error::Failed to get DNS record ID for ${FULL_DOMAIN}"
            exit 1
          fi

          echo "DNS Record ID: $DNS_RECORD_ID"

          # DNSレコードを更新
          DNS_UPDATE_RESPONSE=$(curl -s -X PUT "https://api.cloudflare.com/client/v4/zones/${CLOUDFLARE_ZONE_ID}/dns_records/${DNS_RECORD_ID}" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json" \
            --data "{
              \"type\": \"CNAME\",
              \"name\": \"${FULL_DOMAIN}\",
              \"content\": \"${CLOUD_RUN_HOST}\",
              \"ttl\": 1,
              \"proxied\": true
            }")

          if echo "$DNS_UPDATE_RESPONSE" | jq -e '.success == true' > /dev/null; then
            echo "✅ DNS record updated successfully"
            echo "   ${FULL_DOMAIN} -> ${CLOUD_RUN_HOST}"
          else
            echo "::error::Failed to update DNS record"
            echo "$DNS_UPDATE_RESPONSE" | jq .
            exit 1
          fi
          echo "::endgroup::"

          echo "::notice::Cloudflare DNS updated successfully for ${{ inputs.environment }} environment"

      - name: Health Check
        id: health_check
        run: |
          echo "Waiting for service to be ready..."
          sleep 10

          MAX_RETRIES=10
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Health check attempt $((RETRY_COUNT + 1))/$MAX_RETRIES"

            if curl -f -s "${{ env.SERVICE_URL }}/api/health" > /dev/null; then
              echo "✅ Health check passed!"
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            fi

            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "Health check failed, retrying in 10 seconds..."
              sleep 10
            fi
          done

          echo "❌ Health check failed after $MAX_RETRIES attempts"
          echo "status=failure" >> $GITHUB_OUTPUT
          exit 1

      - name: Deployment Summary
        if: success()
        run: |
          echo "# Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ steps.image_tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Service URL:** ${{ env.SERVICE_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Service Name:** ${{ env.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Region:** ${{ env.REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ steps.image_tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY

      - name: Report Success
        if: success()
        run: |
          echo "::notice::Deployment to ${{ inputs.environment }} environment completed successfully"
          echo "::notice::Service URL: ${{ env.SERVICE_URL }}"
          echo "::notice::Image: ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ steps.image_tag.outputs.tag }}"

      - name: Report Failure
        if: failure()
        run: |
          echo "::error::Deployment to ${{ inputs.environment }} environment failed"
