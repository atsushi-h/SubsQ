name: Claude Code Review

on:
  issue_comment:
    types: [created]

jobs:
  claude-review:
    # PRã‚³ãƒ¡ãƒ³ãƒˆã§ @claude ã‚’å«ã‚€å ´åˆã®ã¿å®Ÿè¡Œ
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@claude')
    
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          plugin_marketplaces: |
            https://github.com/anthropics/claude-plugins-official.git
          plugins: |
            pr-review-toolkit@claude-plugins-official
            code-review@claude-plugins-official
            security-guidance@claude-plugins-official
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.issue.number }}
            COMMENT_ID: ${{ github.event.comment.id }}

            ä»¥ä¸‹ã®æ‰‹é †ã§PRãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚ãƒªãƒã‚¸ãƒˆãƒªã®CLAUDE.mdã‚‚å‚ç…§ã—ã€æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã‚„è¦ç´„ã«é–¢ã™ã‚‹ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ã«å¾“ã£ã¦ãã ã•ã„ã€‚

            ## 1. PRã®åŒ…æ‹¬çš„ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œ
            ä»¥ä¸‹ã®è¦³ç‚¹ã§ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š
            - ã‚³ãƒ¡ãƒ³ãƒˆã¨æ–‡æ›¸åŒ–ã®å“è³ª
            - ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã¨å“è³ª
            - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆã‚µã‚¤ãƒ¬ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼ã®æ¤œå‡ºï¼‰
            - å‹è¨­è¨ˆã®é©åˆ‡ã•
            - ã‚³ãƒ¼ãƒ‰å“è³ªã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
            - ã‚³ãƒ¼ãƒ‰ã®ç°¡ç´ åŒ–å¯èƒ½æ€§
            - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®æ‡¸å¿µ

            ## 2. ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’PRæ¦‚è¦æ¬„ã«è¨˜å…¥
            ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’ä»¥ä¸‹ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå½¢å¼ã§PRæ¦‚è¦æ¬„ã«è¿½è¨˜ã—ã¦ãã ã•ã„ã€‚

            ### æ‰‹é †
            1. ç¾åœ¨ã®PRæ¦‚è¦ã‚’å–å¾—: `gh pr view [PRç•ªå·] --json body -q .body`
            2. æ¦‚è¦å†…ã« `<!-- CLAUDE_REVIEW_START -->` ã¨ `<!-- CLAUDE_REVIEW_END -->` ã®ãƒãƒ¼ã‚«ãƒ¼ãŒã‚ã‚Œã°ã€ãã®é–“ã®å†…å®¹ã‚’æ–°ã—ã„ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ç½®æ›
            3. ãƒãƒ¼ã‚«ãƒ¼ãŒãªã‘ã‚Œã°ã€æ¦‚è¦ã®æœ«å°¾ã«è¿½åŠ 
            4. PRæ¦‚è¦ã‚’æ›´æ–°: `gh pr edit [PRç•ªå·] --body "æ›´æ–°å¾Œã®å…¨æ–‡"`

            ### ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
            ```markdown
            <!-- CLAUDE_REVIEW_START -->
            ---
            ## ğŸ¤– Claude Code Review

            ### ğŸ“‹ æ¦‚è¦
            [å¤‰æ›´å†…å®¹ã®ç°¡æ½”ãªè¦ç´„ã‚’1-2æ–‡ã§]

            ### ğŸ“ å¤‰æ›´å†…å®¹ã®è©³ç´°
            **å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§:**
            - `ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹`: å¤‰æ›´å†…å®¹ã®ç°¡æ½”ãªèª¬æ˜

            **é‡è¦ãªå¤‰æ›´:**
            [ç‰¹ã«é‡è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚„å¤‰æ›´ã«ã¤ã„ã¦è©³ã—ãèª¬æ˜]

            ### âœ… è‰¯ã„ç‚¹
            - [ã‚³ãƒ¼ãƒ‰å“è³ªã‚„ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®è¦³ç‚¹ã‹ã‚‰è‰¯ã„ç‚¹ã‚’ãƒªã‚¹ãƒˆã§è¨˜è¿°]

            ### âš ï¸ æ”¹å–„ææ¡ˆ
            - **[ã‚«ãƒ†ã‚´ãƒª]** `ãƒ•ã‚¡ã‚¤ãƒ«å` Lè¡Œç•ªå·: [å…·ä½“çš„ãªæŒ‡æ‘˜å†…å®¹]

            *(ã‚«ãƒ†ã‚´ãƒª: [è¦ç´„é•å], [ãƒã‚°å¯èƒ½æ€§], [å¯èª­æ€§], [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹], [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£], [ãƒ†ã‚¹ãƒˆ], [é‡è¤‡å®Ÿè£…] ãªã©)*

            ### ğŸ› æ½œåœ¨çš„ãªå•é¡Œ
            - [ãƒã‚°ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æ‡¸å¿µã‚’ãƒªã‚¹ãƒˆã§è¨˜è¿°]

            ### ğŸ“Š ç·åˆè©•ä¾¡
            **ãƒãƒ¼ã‚¸æ¨å¥¨åº¦: X/10**
            [å…¨ä½“çš„ãªè©•ä¾¡ã‚’1-2æ–‡ã§ã€‚ã‚¹ã‚³ã‚¢ã®ç†ç”±ã‚‚ç°¡æ½”ã«èª¬æ˜]

            <!-- CLAUDE_REVIEW_END -->
            ```

            ## 3. å®Œäº†å¾Œã€ä¾é ¼ã‚³ãƒ¡ãƒ³ãƒˆã«ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            ```bash
            gh api repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions -f content='+1'
            ```

            ## é‡è¦ãªæ³¨æ„äº‹é …
            - å„æŒ‡æ‘˜ã«ã¯å¿…ãšãƒ•ã‚¡ã‚¤ãƒ«åã¨è¡Œç•ªå·ã‚’ä»˜ä¸ã™ã‚‹
            - è©²å½“ãŒãªã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ã€Œç‰¹ã«ãªã—ã€ã¨è¨˜è¼‰
            - ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯æ—¥æœ¬èªã§è¡Œã†

          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          claude_args: '--allowedTools "Bash(gh issue view:*)" "Bash(gh search:*)" "Bash(gh issue list:*)" "Bash(gh pr diff:*)" "Bash(gh pr view:*)" "Bash(gh pr list:*)" "Bash(gh pr edit:*)" "Bash(gh api:*)"'
